name: Release Chart

on:
  workflow_dispatch:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
    paths:
      - 'chart/**'
      - '.github/workflows/release_charts.yml'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v3.3
        with:
          version: v3.8.1

      - name: Install additional Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami

      - name: Install Go
        uses: actions/setup-go@v5
        with:
            go-version: "1.23.x"

      - name: Generate CRDs
        run: |
            go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.16.4
            make generate manifests
            cp config/crd/bases/* chart/hlf-operator/templates/crds/

      # If this workflow was triggered by a tag push, extract the tag and set the Chart.yaml version to the tag (stripping a leading "v")
      - name: Extract tag and set VERSION
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "Tag: $TAG"
          echo "Derived chart version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Update Helm Chart version from tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          # Update the chart version field in Chart.yaml to match the tag-derived VERSION.
          # This does an in-place replace of the first 'version:' line (allowing leading whitespace).
          sed -E -i "s/^[[:space:]]*version:.*/version: $VERSION/" chart/hlf-operator/Chart.yaml
          echo "Updated chart/hlf-operator/Chart.yaml:"
          head -n 120 chart/hlf-operator/Chart.yaml

      - name: Operator charts
        uses: helm/chart-releaser-action@v1.6.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        with:
          charts_dir: chart
          skip_existing: true
